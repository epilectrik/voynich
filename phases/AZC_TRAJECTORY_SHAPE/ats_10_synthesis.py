#!/usr/bin/env python3
"""
ats_10_synthesis.py - AZC_TRAJECTORY_SHAPE Synthesis

Aggregates results from all 9 hypothesis tests and generates final tier assessment.
"""

import json
from pathlib import Path
from datetime import datetime

PROJECT_ROOT = Path(__file__).parent.parent.parent
RESULTS_DIR = PROJECT_ROOT / "results"
PHASE_DIR = Path(__file__).parent


def load_result(filename):
    """Load a result file if it exists."""
    path = RESULTS_DIR / filename
    if path.exists():
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)
    return None


def generate_report(synthesis):
    """Generate markdown report."""
    report = []
    report.append("# AZC_TRAJECTORY_SHAPE Phase Report")
    report.append("")
    report.append(f"**Generated:** {synthesis['timestamp'][:16]}")
    report.append(f"**Status:** COMPLETE")
    report.append("")
    report.append("## Executive Summary")
    report.append("")
    report.append(f"**Tier Assessment:** {synthesis['tier_assessment']['tier']}")
    report.append(f"**Confidence:** {synthesis['tier_assessment']['confidence']}")
    report.append(f"**Rationale:** {synthesis['tier_assessment']['rationale']}")
    report.append("")

    # Key findings
    report.append("> **Key Finding:** " + synthesis.get('key_finding', 'See detailed results'))
    report.append("")
    report.append("---")
    report.append("")

    # Vector 1 results
    report.append("## Vector 1: Trajectory Shape (External Expert)")
    report.append("")
    report.append(f"**Passed:** {synthesis['vector1_summary']['passed']}/{synthesis['vector1_summary']['total']}")
    report.append("")
    report.append("| Hypothesis | Prediction | Result | Status |")
    report.append("|------------|------------|--------|--------|")

    for h in synthesis['hypothesis_results']:
        if h['hypothesis'].startswith('H') and int(h['hypothesis'][1]) <= 5:
            status = "PASS" if h['passed'] else "FAIL"
            report.append(f"| {h['hypothesis']} | {h['prediction'][:40]}... | {h.get('key_metric', 'N/A')} | {status} |")

    report.append("")
    report.append("---")
    report.append("")

    # Vector 2 results
    report.append("## Vector 2: Apparatus Mapping (Expert-Advisor)")
    report.append("")
    report.append(f"**Passed:** {synthesis['vector2_summary']['passed']}/{synthesis['vector2_summary']['total']}")
    report.append("")
    report.append("| Hypothesis | Prediction | Result | Status |")
    report.append("|------------|------------|--------|--------|")

    for h in synthesis['hypothesis_results']:
        if h['hypothesis'].startswith('H') and int(h['hypothesis'][1]) >= 6:
            status = "PASS" if h['passed'] else "FAIL"
            report.append(f"| {h['hypothesis']} | {h['prediction'][:40]}... | {h.get('key_metric', 'N/A')} | {status} |")

    report.append("")
    report.append("---")
    report.append("")

    # Interpretation
    report.append("## Interpretation")
    report.append("")

    if synthesis['tier_assessment']['tier'] == 'TIER_2':
        report.append("Strong evidence supports the hypothesis that Zodiac and A/C families")
        report.append("implement different judgment withdrawal trajectories:")
        report.append("")
        report.append("- **Zodiac:** Wide-then-collapse pattern (sustained coarse monitoring)")
        report.append("- **A/C:** Narrow-then-spike pattern (punctuated checkpoints)")
    elif synthesis['tier_assessment']['tier'] == 'TIER_3_ENRICHMENT':
        report.append("Partial evidence supports family-differentiated trajectories.")
        report.append("The findings enrich our understanding but don't reach Tier 2 certainty.")
    else:
        report.append("Results are inconclusive or suggest the hypothesis should be rejected.")

    report.append("")
    report.append("---")
    report.append("")

    # Constraint compliance
    report.append("## Constraint Compliance")
    report.append("")
    report.append("| Constraint | How Respected |")
    report.append("|------------|---------------|")
    report.append("| C384 | Aggregate distributions only, no token mapping |")
    report.append("| C430 | Explicit Zodiac/A/C family separation |")
    report.append("| C434 | Uses R-series forward ordering |")
    report.append("| C435 | Respects S/R positional division |")
    report.append("")
    report.append("---")
    report.append("")
    report.append("*Report generated by ats_10_synthesis.py*")

    return "\n".join(report)


def main():
    print("=" * 70)
    print("AZC_TRAJECTORY_SHAPE: Synthesis")
    print("=" * 70)
    print()

    # Load all results
    result_files = {
        'H1': 'ats_entropy_trajectory.json',
        'H2': 'ats_monotonicity.json',
        'H3': 'ats_terminal_compression.json',
        'H4': 'ats_peak_analysis.json',
        'H5': 'ats_elimination_order.json',
        'H6': 'ats_middle_restriction.json',
        'H7': 'ats_szone_bterminal.json',
        'H8': 'ats_zone_apparatus.json',
        'H9': 'ats_escape_asymmetry.json',
    }

    results = {}
    for hyp, filename in result_files.items():
        data = load_result(filename)
        if data:
            results[hyp] = data
            print(f"Loaded {hyp}: {filename}")
        else:
            print(f"MISSING {hyp}: {filename}")

    # Count passes
    vector1_passed = 0
    vector1_total = 5
    vector2_passed = 0
    vector2_total = 4

    hypothesis_results = []

    for hyp in ['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'H7', 'H8', 'H9']:
        data = results.get(hyp, {})
        evaluation = data.get('evaluation', {})
        passed = evaluation.get('passed', False)

        # Extract key metric for display
        key_metric = 'N/A'
        if hyp == 'H1':
            stats_data = data.get('statistics', {})
            key_metric = f"d={stats_data.get('cohens_d', 'N/A'):.2f}" if stats_data.get('cohens_d') else 'N/A'
        elif hyp == 'H2':
            zodiac = data.get('zodiac', {})
            key_metric = f"Z_rho={zodiac.get('mean_rho', 'N/A'):.2f}" if zodiac.get('mean_rho') else 'N/A'
        elif hyp == 'H3':
            key_metric = f"diff={data.get('difference', 'N/A'):.2f}" if data.get('difference') else 'N/A'
        elif hyp == 'H4':
            key_metric = f"ratio={data.get('rate_ratio', 'N/A'):.2f}" if data.get('rate_ratio') else 'N/A'
        elif hyp == 'H5':
            stats_data = data.get('statistics', {})
            key_metric = f"tau={stats_data.get('kendalls_tau', 'N/A'):.2f}" if stats_data.get('kendalls_tau') else 'N/A'
        elif hyp == 'H6':
            stats_data = data.get('statistics', {})
            key_metric = f"rho={stats_data.get('spearman_rho', 'N/A'):.2f}" if stats_data.get('spearman_rho') else 'N/A'
        elif hyp == 'H7':
            stats_data = data.get('statistics', {})
            key_metric = f"OR={stats_data.get('odds_ratio', 'N/A'):.2f}" if stats_data.get('odds_ratio') else 'N/A'
        elif hyp == 'H8':
            stats_data = data.get('statistics', {})
            key_metric = f"rho={stats_data.get('spearman_rho', 'N/A'):.2f}" if stats_data.get('spearman_rho') else 'N/A'
        elif hyp == 'H9':
            key_metric = f"v_ratio={data.get('variance_ratio', 'N/A'):.2f}" if data.get('variance_ratio') else 'N/A'

        hypothesis_results.append({
            'hypothesis': hyp,
            'name': data.get('name', 'Unknown'),
            'prediction': data.get('prediction', 'Unknown'),
            'passed': passed,
            'key_metric': key_metric,
        })

        if hyp in ['H1', 'H2', 'H3', 'H4', 'H5']:
            if passed:
                vector1_passed += 1
        else:
            if passed:
                vector2_passed += 1

    total_passed = vector1_passed + vector2_passed
    total_tests = vector1_total + vector2_total

    # Summary
    print("\n" + "-" * 70)
    print("RESULTS SUMMARY")
    print("-" * 70)

    print(f"\nVector 1 (Trajectory Shape): {vector1_passed}/{vector1_total} passed")
    print(f"Vector 2 (Apparatus Mapping): {vector2_passed}/{vector2_total} passed")
    print(f"TOTAL: {total_passed}/{total_tests} passed")

    # Tier assessment
    print("\n" + "-" * 70)
    print("TIER ASSESSMENT")
    print("-" * 70)

    if total_passed >= 7:
        tier = 'TIER_2'
        confidence = 'HIGH'
        rationale = f'Strong evidence: {total_passed}/9 hypotheses passed'
    elif total_passed >= 5:
        tier = 'TIER_3_ENRICHMENT'
        confidence = 'MEDIUM'
        rationale = f'Partial evidence: {total_passed}/9 hypotheses passed'
    elif total_passed >= 3:
        tier = 'TIER_4_SPECULATIVE'
        confidence = 'LOW'
        rationale = f'Suggestive evidence: {total_passed}/9 hypotheses passed'
    else:
        tier = 'FALSIFIED'
        confidence = 'HIGH'
        rationale = f'Insufficient evidence: {total_passed}/9 hypotheses passed'

    print(f"\nTier: {tier}")
    print(f"Confidence: {confidence}")
    print(f"Rationale: {rationale}")

    # Key finding
    key_finding = ""
    if vector1_passed >= 3:
        key_finding = "Trajectory shape differentiation partially confirmed: Zodiac and A/C families show distinct judgment withdrawal patterns."
    elif vector2_passed >= 2:
        key_finding = "Apparatus mapping shows structural correspondence between AZC zones and procedural phases."
    else:
        key_finding = "Neither trajectory shape nor apparatus mapping hypotheses received strong support."

    # Compile synthesis
    synthesis = {
        'phase': 'AZC_TRAJECTORY_SHAPE',
        'timestamp': datetime.now().isoformat(),
        'hypothesis_results': hypothesis_results,
        'vector1_summary': {
            'passed': vector1_passed,
            'total': vector1_total,
            'verdict': 'PARTIAL' if vector1_passed >= 2 else 'WEAK',
        },
        'vector2_summary': {
            'passed': vector2_passed,
            'total': vector2_total,
            'verdict': 'PARTIAL' if vector2_passed >= 2 else 'WEAK',
        },
        'total_passed': total_passed,
        'total_tests': total_tests,
        'tier_assessment': {
            'tier': tier,
            'confidence': confidence,
            'rationale': rationale,
        },
        'key_finding': key_finding,
    }

    # Generate report
    report = generate_report(synthesis)

    # Save
    output_path = RESULTS_DIR / "ats_synthesis.json"
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(synthesis, f, indent=2)
    print(f"\nSynthesis saved to: {output_path}")

    report_path = PHASE_DIR / "AZC_TRAJECTORY_SHAPE_REPORT.md"
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(report)
    print(f"Report saved to: {report_path}")

    return synthesis


if __name__ == "__main__":
    main()
